# 端到端加密聊天室 - 使用说明

## 目录
1. [系统简介](#系统简介)
2. [环境准备](#环境准备)
3. [启动系统](#启动系统)
4. [功能使用详解](#功能使用详解)
5. [常见问题](#常见问题)

---

## 系统简介

这是一个基于密码学的端到端加密聊天系统，具有以下特点：

- **端到端加密**：消息在发送前加密，只有拥有正确密钥的接收方才能解密
- **完整性验证**：每条消息都经过完整性校验，防止被篡改
- **房间限制**：每个房间最多支持2人同时在线
- **密钥指纹**：显示密钥指纹，方便双方验证是否使用相同密钥
- **加密状态显示**：每条消息都显示加密状态（已加密/已验证/解密失败）

---

## 环境准备

### 1. 检查Python版本

打开命令行（Windows: PowerShell 或 CMD），输入：

```powershell
python --version
```

确保Python版本为 **3.7 或更高**。

### 2. 创建虚拟环境（推荐）

在项目目录下执行：

```powershell
conda create -n crypto-chat python=3.10 -y

```

### 3. 激活虚拟环境

**Windows PowerShell:**
```powershell
conda activate crypto-chat
```


### 4. 安装依赖

```powershell
pip install -r requirements.txt
```

如果下载速度慢，可以使用国内镜像：
```powershell
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

---


## 启动系统

### 1. 启动服务器

在项目目录下执行：

```powershell
python server.py
```


### 2. 访问聊天室

打开浏览器，访问：**http://localhost:5000/**

如果5000端口被占用，可以设置环境变量使用其他端口：
```powershell
$env:PORT="5173"
python server.py
```
然后访问 `http://localhost:5173/`

---

## 功能使用详解

### 功能一：加入房间

#### 步骤说明

1. **填写房间ID**
   - 在"房间ID"输入框中输入一个标识符，例如：`crypto-101`
   - 房间ID用于区分不同的聊天房间
   - 只有使用相同房间ID的用户才能互相通信

2. **填写昵称**
   - 在"昵称"输入框中输入你的显示名称，例如：`Alice`
   - 如果不填写，默认显示为"匿名"
   - 昵称会显示在消息中，让对方知道是谁发送的

3. **输入房间口令**
   - 在"房间口令"输入框中输入一个密码，例如：`my-secret-passphrase`
   - **重要**：这个口令用于生成加密密钥，只有使用相同口令的用户才能解密消息
   - 口令不会发送到服务器，只在本地使用
   - 建议使用强密码（包含大小写字母、数字、特殊字符）

4. **点击"加入房间"按钮**
   - 系统会使用你输入的口令和房间ID生成加密密钥
   - 密钥指纹会显示在下方（例如：`a1b2c3d4…e5f6g7h8`）
   - 如果房间未满（少于2人），会成功加入并显示聊天界面
   - 如果房间已满，会显示错误提示

#### 密钥指纹的作用

- 密钥指纹是密钥的唯一标识
- 双方应该通过其他安全渠道（如电话、面对面）比对指纹
- 如果指纹一致，说明双方使用了相同的密钥，可以安全通信
- 如果指纹不一致，说明密钥不同，无法解密对方的消息

#### 房间人数限制

- 每个房间最多支持 **2人** 同时在线
- 如果房间已有2人，第3人尝试加入时会显示错误：
  ```
  ⚠️ 加入房间失败
  房间已满（最多 2 人）
  ```
- 当有人离开房间后，其他人可以重新加入

---

### 功能二：发送消息

#### 步骤说明

1. **确保已成功加入房间**
   - 聊天区域应该已经显示
   - 输入框和"发送"按钮应该可用

2. **输入消息内容**
   - 在底部的消息输入框中输入你想发送的内容
   - 可以输入任意文本，支持中文、英文、数字等

3. **发送消息**
   - 方式一：点击"发送"按钮
   - 方式二：按键盘上的 `Enter` 键

4. **查看消息状态**
   - 你发送的消息会立即显示在聊天区域
   - 消息旁边会显示 **🔒 已加密**（蓝色标签）
   - 这表示消息已经加密，准备发送

#### 加密过程说明

当你点击发送时，系统会：

1. **获取加密密钥**：使用之前生成的房间密钥
2. **生成随机IV**：每次加密都使用不同的初始化向量（IV）
3. **加密消息**：使用 AES-256-GCM 算法加密你的消息
4. **发送密文**：将加密后的数据（IV + 密文）发送到服务器
5. **服务器转发**：服务器只转发加密数据，不查看内容
6. **接收方解密**：对方使用相同的密钥解密消息

---

### 功能三：接收消息

#### 消息显示说明

当收到消息时，会显示以下信息：

1. **消息元数据**
   - 发送者昵称：例如 `[Alice]`
   - 时间戳：消息发送的时间，例如 `2025-01-16T10:30:45.123Z`
   - 加密状态：显示消息的加密验证状态

2. **加密状态标签**

   - **🔒 已验证**（绿色标签）
     - 表示消息成功解密
     - 完整性验证通过（消息未被篡改）
     - 这是正常情况，说明通信安全

   - **⚠️ 解密失败**（红色标签）
     - 表示无法解密消息
     - 可能的原因：
       - 使用了不同的房间口令
       - 消息在传输过程中被篡改
       - 加密数据损坏
     - 会显示详细的错误信息

3. **消息内容**
   - 正常消息：显示解密后的明文内容
   - 错误消息：显示错误原因和可能的情况

#### 完整性验证说明

- AES-GCM 加密模式会自动生成认证标签
- 解密时会自动验证消息是否被篡改
- 如果消息被修改，解密会失败并显示错误
- 这确保了消息的完整性和真实性

---

### 功能四：离开房间

#### 步骤说明

1. **点击"离开房间"按钮**
   - 按钮位于"加入房间"按钮旁边
   - 只有加入房间后才能使用此按钮

2. **系统处理**
   - 断开与房间的连接
   - 清除本地密钥（不再能解密新消息）
   - 恢复输入框状态（可以重新填写信息）
   - 隐藏聊天区域

3. **其他用户看到**
   - 其他房间成员会看到系统提示：
     ```
     [系统] 2025-01-16T10:35:20.456Z
     Alice 离开了房间
     ```

#### 注意事项

- 离开房间后，之前的消息记录仍然保留在页面上
- 但无法再接收新消息
- 可以重新加入房间继续聊天

---

### 功能五：系统消息

系统会自动显示以下消息：

1. **加入通知**
   ```
   [系统] 2025-01-16T10:30:00.000Z
   Bob 加入了房间
   ```
   - 当其他用户加入房间时显示
   - 使用蓝色文字显示

2. **离开通知**
   ```
   [系统] 2025-01-16T10:35:00.000Z
   Bob 离开了房间
   ```
   - 当其他用户离开房间时显示
   - 使用蓝色文字显示

3. **加入成功提示**
   ```
   [系统] 2025-01-16T10:30:00.000Z
   成功加入房间（1/2）
   ```
   - 显示当前房间人数和最大人数
   - 例如 `(1/2)` 表示当前1人，最多2人

---

## 常见问题

### Q1: 为什么我发送的消息对方收不到？

**可能原因：**
1. 对方没有加入相同的房间ID
2. 对方使用了不同的房间口令
3. 网络连接问题

**解决方法：**
- 确认双方使用完全相同的房间ID和房间口令
- 比对密钥指纹是否一致
- 检查网络连接

### Q2: 为什么显示"解密失败"？

**可能原因：**
1. 使用了不同的房间口令（最常见）
2. 消息在传输过程中被篡改
3. 加密数据损坏

**解决方法：**
- 确认双方使用完全相同的房间口令
- 重新发送消息
- 如果持续失败，重新加入房间

### Q3: 为什么无法加入房间？

**可能原因：**
1. 房间已满（已有2人）
2. 房间ID为空
3. 服务器未启动

**解决方法：**
- 等待其他人离开房间
- 检查房间ID是否填写
- 确认服务器正在运行

### Q4: 密钥指纹不一致怎么办？

**说明：**
- 密钥指纹不一致说明双方使用了不同的密钥
- 无法解密对方的消息

**解决方法：**
- 确认双方使用完全相同的房间ID和房间口令
- 注意大小写、空格等细节
- 重新输入并加入房间

### Q5: 如何确保通信安全？

**建议：**
1. 使用强密码作为房间口令（至少16位，包含大小写、数字、特殊字符）
2. 通过安全渠道（电话、面对面）比对密钥指纹
3. 不要在公共网络或不信任的环境中使用
4. 定期更换房间口令

### Q6: 服务器能看到我的消息内容吗？

**答案：不能**

- 服务器只接收和转发加密后的数据
- 服务器无法解密消息内容
- 消息在发送前就在浏览器中加密
- 只有拥有正确密钥的接收方才能解密

### Q7: 可以多人聊天吗？

**当前版本：不支持**

- 每个房间最多支持2人
- 这是为了简化密钥管理
- 未来版本可能支持多人聊天

### Q8: 消息会保存吗？

**答案：不会**

- 消息只存在于浏览器内存中
- 刷新页面后消息会消失
- 服务器不保存任何消息
- 这是为了隐私保护

---

## 使用示例

### 示例场景：Alice 和 Bob 进行加密聊天

1. **Alice 的操作：**
   - 房间ID：`secret-room`
   - 昵称：`Alice`
   - 房间口令：`MySecurePass123!`
   - 点击"加入房间"
   - 密钥指纹：`a1b2c3d4…e5f6g7h8`

2. **Bob 的操作：**
   - 房间ID：`secret-room`（与Alice相同）
   - 昵称：`Bob`
   - 房间口令：`MySecurePass123!`（与Alice相同）
   - 点击"加入房间"
   - 密钥指纹：`a1b2c3d4…e5f6g7h8`（与Alice一致）

3. **Alice 发送消息：**
   - 输入："Hello Bob!"
   - 点击发送
   - 看到：`[我] 2025-01-16T10:30:00.000Z | 🔒 已加密`
   - Bob看到：`[Alice] 2025-01-16T10:30:00.000Z | 🔒 已验证` 和消息内容 "Hello Bob!"

4. **Bob 回复：**
   - 输入："Hi Alice! How are you?"
   - 点击发送
   - Alice看到：`[Bob] 2025-01-16T10:30:05.000Z | 🔒 已验证` 和消息内容

---


**祝使用愉快！**


